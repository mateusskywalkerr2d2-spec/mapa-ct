<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa de Cobertura LTE</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100vh; }

    #msg{
      position:fixed; left:12px; top:12px; z-index:9999;
      background:#fff; padding:10px 12px; border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.15);
      font-family: Arial, sans-serif; font-size:12px;
      max-width:88%;
      white-space: pre-line;
    }

    .zone-tooltip{
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      padding: 6px 8px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: #222;
    }
    .tag{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 11px;
      color: #fff;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="msg">Carregando…</div>

  <script>
    // Debug: se der erro JS, mostra na caixinha
    const msg = document.getElementById("msg");
    window.onerror = function (m, u, l, c) {
      msg.textContent = "ERRO JS: " + m + " (linha " + l + ")";
    };

    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }
    function toNum(v){
      if(v===null || v===undefined || v==="") return NaN;
      return Number(String(v).trim().replace(",", "."));
    }
    function cor(rank){
      rank = Number(rank || 0);
      if(rank === 1) return "#0B8043";
      if(rank <= 3) return "#6AA84F";
      if(rank <= 5) return "#F1C232";
      if(rank <= 8) return "#E69138";
      return "#B00020";
    }

    // Centro opcional (vem do Power Apps)
    const lat = toNum(getParam("lat"));
    const lon = toNum(getParam("lon"));

    // Mapa
    const map = L.map("map").setView(
      (!isNaN(lat) && !isNaN(lon)) ? [lat, lon] : [-6.05, -50.17],
      13
    );

    // Base (rua) — simples pra teste
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
      maxZoom: 19
    }).addTo(map);

    // -------------------------
    // 1) Tenta modo novo: ovl
    // -------------------------
    let overlays = [];
    const ovlParam = getParam("ovl");

    if (ovlParam) {
      try {
        overlays = JSON.parse(decodeURIComponent(ovlParam));
        if (!Array.isArray(overlays)) overlays = [];
      } catch (e) {
        overlays = [];
        msg.textContent = "Falha ao ler ovl (JSON). Verifique EncodeUrl no Power Apps.";
      }
    }

    // -------------------------
    // 2) Fallback modo antigo
    // -------------------------
    if (overlays.length === 0) {
      const imgUrl = getParam("img");
      const north = toNum(getParam("north"));
      const south = toNum(getParam("south"));
      const east  = toNum(getParam("east"));
      const west  = toNum(getParam("west"));
      const name  = getParam("name") ? decodeURIComponent(getParam("name")) : "Zona";

      if (imgUrl && !isNaN(north) && !isNaN(south) && !isNaN(east) && !isNaN(west)) {
        overlays = [{
          img: imgUrl,
          north, south, east, west,
          name,
          rank: 1
        }];
      }
    }

    // -------------------------
    // 3) Render
    // -------------------------
    if (overlays.length === 0) {
      msg.textContent = "Sem parâmetros válidos. Use ovl=... (lista) ou img/north/south/east/west.";
    } else {
      // TRAVA PRA TESTE: só 3 overlays
      overlays = overlays.slice(0, 3);

      const group = L.featureGroup();
      let carregadas = 0;
      msg.textContent = "Recebi " + overlays.length + " overlay(s). Carregando…";

      overlays.forEach((o, idx) => {
        const north = Number(o.north), south = Number(o.south), east = Number(o.east), west = Number(o.west);
        const imgUrl = o.img;
        const nome = String(o.name || ("Zona " + (idx+1)));
        const rank = Number(o.rank || (idx+1));

        if (!imgUrl || [north,south,east,west].some(v => Number.isNaN(v))) {
          msg.textContent = "Overlay inválido detectado (faltando img ou bounds numéricos).";
          return;
        }

        const bounds = [[south, west], [north, east]];

        const overlay = L.imageOverlay(imgUrl, bounds, { opacity: 0.62, interactive: true })
          .addTo(map)
          .on("error", () => {
            msg.textContent = "Falhou ao carregar algum overlay. Teste abrir a URL da imagem direto no navegador.";
          })
          .on("load", () => {
            carregadas++;
            msg.textContent = "Overlays carregados: " + carregadas + "/" + overlays.length;
          });

        group.addLayer(overlay);

        // Tooltip/Tag no centro do bbox
        const cLat = (south + north) / 2;
        const cLon = (west + east) / 2;
        const html = `<span class="tag" style="background:${cor(rank)}">P${rank}</span>${nome}`;

        L.marker([cLat, cLon], { opacity: 0 })
          .addTo(map)
          .bindTooltip(html, {
            permanent: true,
            direction: "center",
            className: "zone-tooltip"
          });
      });

      // Zoom para todas
      if (group.getLayers().length > 0) {
        map.fitBounds(group.getBounds(), { padding: [25, 25] });
      }

      // Marca o ponto consultado (se veio)
      if (!isNaN(lat) && !isNaN(lon)) {
        L.circleMarker([lat, lon], { radius: 7, weight: 2, fillOpacity: 0.9 }).addTo(map);
      }
    }
  </script>
</body>
</html>
