<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa de Cobertura LTE</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100vh; }

    /* ============================
       PAINEL PREVIEW (recolhÃ­vel)
       ============================ */
    #panel {
      position:fixed; left:12px; bottom:12px; z-index:9999;
      width:320px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 12px 34px rgba(0,0,0,.18);
      font-family: Arial, sans-serif;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }

    #panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background:linear-gradient(180deg, #ffffff, #fbfbfb);
      border-bottom:1px solid rgba(0,0,0,.06);
      cursor:pointer;
      user-select:none;
    }

    #panelHeader .left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }

    .tag{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:11px;
      color:#fff;
      flex:0 0 auto;
    }

    #pTitle{
      font-weight:800;
      font-size:12px;
      color:#111;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    #panelHeader .chev{
      font-size:18px;
      color:#444;
      line-height:1;
      padding:4px 8px;
      border-radius:10px;
      background:#f2f2f2;
    }

    #panelBody{
      padding:10px 12px 12px;
      display:block;
    }

    #pSub{
      margin:0 0 10px 0;
      font-size:11px;
      color:#444;
      white-space:pre-line;
    }

    #pImg{
      width:100%;
      height:165px;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.08);
      background:#f3f3f3;
      display:block;
    }

    #panelActions{
      display:flex; gap:8px; margin-top:10px;
    }

    .btn{
      flex:1 1 auto;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.10);
      background:#fff;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{ background:#f7f7f7; }

    /* Estado minimizado (painel vira "botÃ£o") */
    .min #panelBody{ display:none; }
    .min #panelHeader{ border-bottom:none; }

    /* ============================
       CHIP (contador) + DRAWER LIST
       ============================ */
    #chip {
      position:fixed; right:12px; bottom:12px; z-index:9999;
      background:#111;
      color:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-family: Arial, sans-serif;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      box-shadow:0 12px 34px rgba(0,0,0,.22);
      user-select:none;
    }

    #drawer {
      position:fixed; right:12px; bottom:56px; z-index:9999;
      width:340px;
      max-height:60vh;
      background:#fff;
      border-radius:16px;
      box-shadow:0 12px 34px rgba(0,0,0,.18);
      border:1px solid rgba(0,0,0,.06);
      overflow:hidden;
      display:none;
      font-family: Arial, sans-serif;
    }

    #drawerHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background:linear-gradient(180deg, #ffffff, #fbfbfb);
      border-bottom:1px solid rgba(0,0,0,.06);
      font-weight:900;
      font-size:12px;
    }

    #drawerList{
      overflow:auto;
      max-height:calc(60vh - 44px);
    }

    .row{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 12px;
      border-bottom:1px solid rgba(0,0,0,.06);
      cursor:pointer;
    }
    .row:hover{ background:#f7f7f7; }

    .row .name{
      font-size:12px; font-weight:800; color:#111;
      line-height:1.2;
    }
    .row .meta{
      font-size:11px; color:#555; margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:240px;
    }

    /* botÃ£o pequeno (ðŸ“Œ) dentro da linha */
    .miniBtn{
      border:none;
      background:#f2f2f2;
      border-radius:10px;
      padding:6px 8px;
      cursor:pointer;
      font-size:14px;
      line-height:1;
    }
    .miniBtn:hover{ background:#e9e9e9; }

    /* ============================
       TOOLTIP do Leaflet (tag P#)
       - vamos mostrar sÃ³ na selecionada
       ============================ */
    .zone-tooltip{
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      padding: 6px 8px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: #222;
    }
    .zone-tooltip .tag{
      padding: 2px 8px;
      font-size: 11px;
      margin-right: 6px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Painel preview (recolhÃ­vel) -->
  <div id="panel" class="min">
    <div id="panelHeader" title="Clique para expandir/recolher">
      <div class="left">
        <span id="pTag" class="tag" style="background:#777;">P?</span>
        <div id="pTitle">Nenhuma zona selecionada</div>
      </div>
      <div class="chev" id="chev">âŒƒ</div>
    </div>

    <div id="panelBody">
      <p id="pSub">Clique em uma mancha (overlay) ou escolha na lista.</p>
      <img id="pImg" alt="PrÃ©via do overlay" />
      <div id="panelActions">
        <button class="btn" id="btnAll">Mostrar todas</button>
        <button class="btn" id="btnList">Lista de zonas</button>
      </div>
    </div>
  </div>

  <!-- Chip contador e drawer -->
  <div id="chip">0 zonas</div>

  <div id="drawer">
    <div id="drawerHeader">
      <div id="drawerTitle">Zonas de cobertura</div>
      <div style="cursor:pointer; padding:4px 8px; border-radius:10px; background:#f2f2f2;" id="drawerClose">âœ•</div>
    </div>
    <div id="drawerList"></div>
  </div>

  <script>
    /* =========================================================
       Helpers (querystring, nÃºmero, cor por prioridade)
       ========================================================= */
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }
    function toNum(v){
      if(v===null || v===undefined || v==="") return NaN;
      return Number(String(v).trim().replace(",", "."));
    }
    function cor(rank){
      rank = Number(rank || 0);
      if(rank === 1) return "#0B8043";
      if(rank <= 3) return "#6AA84F";
      if(rank <= 5) return "#F1C232";
      if(rank <= 8) return "#E69138";
      return "#B00020";
    }

    /* =========================================================
       DOM refs
       ========================================================= */
    const panel = document.getElementById("panel");
    const panelHeader = document.getElementById("panelHeader");
    const chev = document.getElementById("chev");
    const pTag = document.getElementById("pTag");
    const pTitle = document.getElementById("pTitle");
    const pSub = document.getElementById("pSub");
    const pImg = document.getElementById("pImg");

    const chip = document.getElementById("chip");
    const drawer = document.getElementById("drawer");
    const drawerList = document.getElementById("drawerList");
    const drawerClose = document.getElementById("drawerClose");

    const btnAll = document.getElementById("btnAll");
    const btnList = document.getElementById("btnList");

    /* =========================================================
       InicializaÃ§Ã£o do mapa
       - SatÃ©lite + Rua (toggle)
       - Ponto azul sempre (se vier lat/lon)
       ========================================================= */
    const lat = toNum(getParam("lat"));
    const lon = toNum(getParam("lon"));

    const map = L.map("map").setView(
      (!isNaN(lat) && !isNaN(lon)) ? [lat, lon] : [-6.05, -50.17],
      13
    );

    const rua = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap contributors",
      maxZoom: 19
    });

    const sat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution: "Tiles Â© Esri", maxZoom: 19 }
    );

    // default: satÃ©lite (mais bonito)
    sat.addTo(map);

    L.control.layers(
      { "SatÃ©lite (Esri)": sat, "Rua (OSM)": rua },
      null,
      { position: "topright" }
    ).addTo(map);

    // Ponto azul SEMPRE (mesmo fora da cobertura)
    if (!isNaN(lat) && !isNaN(lon)) {
      L.circleMarker([lat, lon], {
        radius: 7,
        color: "#0B5FFF",
        weight: 2,
        fillColor: "#0B5FFF",
        fillOpacity: 0.95
      }).addTo(map);
    }

    /* =========================================================
       Leitura dos overlays
       - modo novo: ovl (JSON URL-encoded)
       - fallback: modo antigo (img,north,south,east,west,name)
       ========================================================= */
    let overlays = [];
    const ovlParam = getParam("ovl");

    if (ovlParam) {
      try {
        overlays = JSON.parse(decodeURIComponent(ovlParam));
        if (!Array.isArray(overlays)) overlays = [];
      } catch (e) {
        overlays = [];
      }
    }

    if (overlays.length === 0) {
      const imgUrl = getParam("img");
      const north = toNum(getParam("north"));
      const south = toNum(getParam("south"));
      const east  = toNum(getParam("east"));
      const west  = toNum(getParam("west"));
      const name  = getParam("name") ? decodeURIComponent(getParam("name")) : "Zona";

      if (imgUrl && !isNaN(north) && !isNaN(south) && !isNaN(east) && !isNaN(west)) {
        overlays = [{
          img: imgUrl,
          north, south, east, west,
          name,
          rank: 1
        }];
      }
    }

    /* =========================================================
       Estado / estruturas
       ========================================================= */
    const group = L.featureGroup();
    const overlayLayers = []; // [{ layer, data, tooltipMarker }]
    let selectedIndex = -1;

    // Ajustes UX de opacidade
    const OPACITY_ALL = 0.18;      // quando "Mostrar todas"
    const OPACITY_SELECTED = 0.85; // selecionada em foco
    const OPACITY_OTHERS = 0.0;    // SOLO: outras somem (0)

    /* =========================================================
       FunÃ§Ãµes de UI
       ========================================================= */
    function setPanelMin(min){
      if(min){
        panel.classList.add("min");
        chev.textContent = "âŒƒ";
      } else {
        panel.classList.remove("min");
        chev.textContent = "âŒ„";
      }
    }

    function openDrawer(open){
      drawer.style.display = open ? "block" : "none";
    }

    function renderChip(){
      chip.textContent = `${overlayLayers.length} zona${overlayLayers.length === 1 ? "" : "s"}`;
    }

    function updatePreview(data){
      if(!data){
        pTag.style.background = "#777";
        pTag.textContent = "P?";
        pTitle.textContent = "Nenhuma zona selecionada";
        pSub.textContent = "Clique em uma mancha (overlay) ou escolha na lista.";
        pImg.removeAttribute("src");
        return;
      }

      const rank = Number(data.rank || 0);
      pTag.style.background = cor(rank);
      pTag.textContent = "P" + rank;
      pTitle.textContent = data.name || "Zona";
      pSub.textContent =
        `Prioridade: P${rank}\n` +
        `N ${data.north} | S ${data.south}\n` +
        `E ${data.east} | W ${data.west}`;
      pImg.src = data.img;
    }

    /* =========================================================
       Mostrar todas (modo "visÃ£o geral")
       - volta as opacidades para um valor leve
       - limpa seleÃ§Ã£o
       - esconde tooltips (menos poluÃ­do)
       ========================================================= */
    function showAll(){
      selectedIndex = -1;

      overlayLayers.forEach(o => {
        o.layer.setOpacity(OPACITY_ALL);
        try { o.layer.bringToBack(); } catch(e){}

        // esconde tooltip
        if (o.tooltipMarker) {
          try { o.tooltipMarker.closeTooltip(); } catch(e){}
        }
      });

      updatePreview(null);
      setPanelMin(true);
    }

    /* =========================================================
       Selecionar overlay (modo SOLO)
       - selecionada fica forte
       - demais somem
       - tooltip aparece sÃ³ na selecionada
       - atualiza preview
       - (opcional) fitBounds
       ========================================================= */
    function selectOverlay(i, fit=false){
      if(i < 0 || i >= overlayLayers.length) return;
      selectedIndex = i;

      overlayLayers.forEach((o, idx) => {
        o.layer.setOpacity(idx === i ? OPACITY_SELECTED : OPACITY_OTHERS);

        if(idx === i){
          try { o.layer.bringToFront(); } catch(e){}
          if (o.tooltipMarker) {
            try { o.tooltipMarker.openTooltip(); } catch(e){}
          }
        } else {
          if (o.tooltipMarker) {
            try { o.tooltipMarker.closeTooltip(); } catch(e){}
          }
        }
      });

      const data = overlayLayers[i].data;
      updatePreview(data);
      setPanelMin(false);

      if(fit){
        const b = [[Number(data.south), Number(data.west)], [Number(data.north), Number(data.east)]];
        map.fitBounds(b, { padding:[25,25] });
      }
    }

    /* =========================================================
       Focus (ðŸ“Œ) - sÃ³ centraliza no mapa sem selecionar
       ========================================================= */
    function focusOverlay(i){
      if(i < 0 || i >= overlayLayers.length) return;
      const d = overlayLayers[i].data;
      const b = [[Number(d.south), Number(d.west)], [Number(d.north), Number(d.east)]];
      map.fitBounds(b, { padding:[25,25] });
    }

    /* =========================================================
       Drawer List
       - clique na linha = selectOverlay + fitBounds + fecha lista
       - ðŸ“Œ = focusOverlay sem selecionar
       ========================================================= */
    function buildList(){
      drawerList.innerHTML = "";

      overlayLayers.forEach((o, idx) => {
        const d = o.data;

        const row = document.createElement("div");
        row.className = "row";

        row.innerHTML = `
          <span class="tag" style="background:${cor(d.rank)}">P${d.rank}</span>

          <div style="min-width:0; flex:1 1 auto;">
            <div class="name">${d.name || "Zona"}</div>
            <div class="meta">BBox: ${d.south}, ${d.west} â†’ ${d.north}, ${d.east}</div>
          </div>

          <div style="display:flex; gap:6px; align-items:center;">
            <button class="miniBtn" title="Centralizar no mapa (sem selecionar)">ðŸ“Œ</button>
          </div>
        `;

        // Clique na linha = selecionar (SOLO)
        row.onclick = () => {
          selectOverlay(idx, true);
          openDrawer(false);
        };

        // Pin = sÃ³ centraliza
        const pinBtn = row.querySelector(".miniBtn");
        pinBtn.onclick = (e) => {
          e.stopPropagation();
          focusOverlay(idx);
        };

        drawerList.appendChild(row);
      });
    }

    /* =========================================================
       Eventos de UI
       ========================================================= */
    panelHeader.onclick = () => setPanelMin(!panel.classList.contains("min"));
    chip.onclick = () => openDrawer(drawer.style.display !== "block");
    drawerClose.onclick = () => openDrawer(false);

    btnAll.onclick = (e) => { e.stopPropagation(); showAll(); };
    btnList.onclick = (e) => { e.stopPropagation(); openDrawer(true); };

    /* =========================================================
       RenderizaÃ§Ã£o dos overlays no mapa
       ========================================================= */
    if (overlays.length === 0) {
      // Mesmo sem overlay: mantÃ©m ponto azul (se tiver), chip 0, painel minimizado
      renderChip();
      updatePreview(null);
      setPanelMin(true);
    } else {
      overlays.forEach((o, idx) => {
        const north = Number(o.north), south = Number(o.south), east = Number(o.east), west = Number(o.west);
        const imgUrl = o.img;
        const nome = String(o.name || ("Zona " + (idx+1)));
        const rank = Number(o.rank || (idx+1));

        // validaÃ§Ã£o
        if (!imgUrl || [north,south,east,west].some(v => Number.isNaN(v))) return;

        const data = { img: imgUrl, north, south, east, west, name: nome, rank };

        const bounds = [[south, west], [north, east]];

        // Overlay com opacidade "geral" por padrÃ£o
        const layer = L.imageOverlay(imgUrl, bounds, { opacity: OPACITY_ALL, interactive: true })
          .addTo(map)
          .on("click", () => selectOverlay(idx)); // clique na mancha = selecionar (SOLO)

        group.addLayer(layer);

        // Tooltip marker (invisÃ­vel) no centro do bbox
        // -> nÃ£o Ã© permanent, a gente abre sÃ³ quando seleciona (menos poluiÃ§Ã£o)
        const cLat = (south + north) / 2;
        const cLon = (west + east) / 2;
        const html = `<span class="tag" style="background:${cor(rank)}">P${rank}</span>${nome}`;

        const tooltipMarker = L.marker([cLat, cLon], { opacity: 0 })
          .addTo(map)
          .bindTooltip(html, {
            permanent: false,
            direction: "center",
            className: "zone-tooltip"
          });

        overlayLayers.push({ layer, data, tooltipMarker });
      });

      // UI final
      renderChip();
      buildList();
      updatePreview(null);
      setPanelMin(true);

      // zoom inicial para ver todas as manchas
      if (group.getLayers().length > 0) {
        map.fitBounds(group.getBounds(), { padding: [25, 25] });
      }
    }
  </script>
</body>
</html>
