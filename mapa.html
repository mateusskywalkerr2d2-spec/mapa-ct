<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa de Cobertura LTE</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100vh; }

    /* ============================
       CHIP (contador) - canto inferior direito
       ============================ */
    #chip {
      position:fixed; right:12px; bottom:12px; z-index:9999;
      background:#111;
      color:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-family: Arial, sans-serif;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      box-shadow:0 12px 34px rgba(0,0,0,.22);
      user-select:none;
    }

    /* ============================
       CHIP ESQUERDO (controles) - parecido com o da direita
       ============================ */
    #leftChip {
      position:fixed; left:12px; bottom:12px; z-index:9999;
      background:#111;
      color:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-family: Arial, sans-serif;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      box-shadow:0 12px 34px rgba(0,0,0,.22);
      user-select:none;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #leftChip .miniBtn{
      border:none;
      background:rgba(255,255,255,0.14);
      color:#fff;
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-size:12px;
      font-weight:900;
      line-height:1;
    }
    #leftChip .miniBtn:hover{ background:rgba(255,255,255,0.22); }

    /* ============================
       PAINEL DE CONTROLES (aparece/ some pelo chip esquerdo)
       ============================ */
    #panel {
      position:fixed; left:12px; bottom:56px; z-index:9999;
      width:360px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 12px 34px rgba(0,0,0,.18);
      border:1px solid rgba(0,0,0,.06);
      font-family: Arial, sans-serif;
      overflow:hidden;
      display:block; /* come√ßa vis√≠vel; pode trocar pra none se quiser */
    }

    #panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background:linear-gradient(180deg, #ffffff, #fbfbfb);
      border-bottom:1px solid rgba(0,0,0,.06);
      font-weight:900;
      font-size:12px;
    }

    #panelBody{
      padding:10px 12px 12px;
    }

    #panelActions{
      display:flex; gap:8px;
    }

    .btn{
      flex:1 1 auto;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.10);
      background:#fff;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{ background:#f7f7f7; }

    #selectedBox{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.08);
      background:#fbfbfb;
      min-width:0;
    }

    .tag{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:11px;
      color:#fff;
      flex:0 0 auto;
    }

    #selectedName{
      font-weight:900;
      font-size:12px;
      color:#111;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #selectedHint{
      font-size:11px;
      color:#666;
      margin-top:4px;
    }

    /* ============================
       DRAWER (lista de zonas) - come√ßa aberto
       ============================ */
    #drawer {
      position:fixed; right:12px; bottom:56px; z-index:9999;
      width:380px;
      max-height:65vh;
      background:#fff;
      border-radius:16px;
      box-shadow:0 12px 34px rgba(0,0,0,.18);
      border:1px solid rgba(0,0,0,.06);
      overflow:hidden;
      display:block; /* come√ßa ABERTO */
      font-family: Arial, sans-serif;
    }

    #drawerHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background:linear-gradient(180deg, #ffffff, #fbfbfb);
      border-bottom:1px solid rgba(0,0,0,.06);
      font-weight:900;
      font-size:12px;
    }

    #drawerList{
      overflow:auto;
      max-height:calc(65vh - 44px);
    }

    .row{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 12px;
      border-bottom:1px solid rgba(0,0,0,.06);
      cursor:pointer;
    }
    .row:hover{ background:#f7f7f7; }

    .row .name{
      font-size:12px;
      font-weight:900;
      color:#111;
      line-height:1.2;
    }
    .row .meta{
      font-size:11px;
      color:#555;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:230px;
    }

    .thumb{
      width:92px;
      height:58px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.10);
      object-fit:cover;
      background:#f3f3f3;
      flex:0 0 auto;
    }

    /* ============================
       PILL CLIC√ÅVEL no mapa (consertado o fundo branco)
       ============================ */
    /* garante que o container do Leaflet n√£o ‚Äúengula‚Äù o estilo */
    .leaflet-marker-icon.zone-pill {
      background: transparent !important;
      border: none !important;
    }

    .zone-pill { background: transparent; border:none; }

    .zone-pill .pill{
      display:inline-flex; /* IMPORTANT: garante tamanho do fundo */
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,0.96); /* fundo branco do pill */
      border: 1px solid rgba(0,0,0,0.12);
      box-shadow: 0 10px 26px rgba(0,0,0,0.16);
      font-family: Arial, sans-serif;
      font-size: 12px;
      font-weight: 900;
      color:#111;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }

    .zone-pill .pill .tag{
      padding:2px 8px;
      border-radius:999px;
      font-weight:900;
      font-size:11px;
      color:#fff;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Chip esquerdo (toggle painel de controles) -->
  <div id="leftChip">
    <span>CONTROLES</span>
    <button class="miniBtn" id="btnTogglePanel" title="Mostrar/ocultar painel (screenshot)">üìå</button>
  </div>

  <!-- Painel de controles -->
  <div id="panel">
    <div id="panelHeader">
      <div>Controle de visualiza√ß√£o</div>
      <div style="cursor:pointer; padding:4px 8px; border-radius:10px; background:#f2f2f2;" id="panelClose">‚úï</div>
    </div>

    <div id="panelBody">
      <div id="panelActions">
        <button class="btn" id="btnAll">MOSTRAR TODAS</button>
        <button class="btn" id="btnList">LISTA DE ZONAS</button>
      </div>

      <div id="selectedBox">
        <span id="selTag" class="tag" style="background:#777;">P?</span>
        <div style="min-width:0;">
          <div id="selectedName">Nenhuma zona selecionada</div>
          <div id="selectedHint">Clique numa mancha ou no pill (P# + nome) para filtrar.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chip contador (toggle drawer) -->
  <div id="chip">0 zonas</div>

  <!-- Drawer de zonas -->
  <div id="drawer">
    <div id="drawerHeader">
      <div>Zonas de cobertura</div>
      <div style="cursor:pointer; padding:4px 8px; border-radius:10px; background:#f2f2f2;" id="drawerClose">‚úï</div>
    </div>
    <div id="drawerList"></div>
  </div>

  <script>
    /* ============================
       Helpers
       ============================ */
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }
    function toNum(v){
      if(v===null || v===undefined || v==="") return NaN;
      return Number(String(v).trim().replace(",", "."));
    }
    function cor(rank){
      rank = Number(rank || 0);
      if(rank === 1) return "#0B8043";
      if(rank <= 3) return "#6AA84F";
      if(rank <= 5) return "#F1C232";
      if(rank <= 8) return "#E69138";
      return "#B00020";
    }

    /* ============================
       DOM
       ============================ */
    const panel = document.getElementById("panel");
    const panelClose = document.getElementById("panelClose");
    const btnTogglePanel = document.getElementById("btnTogglePanel");

    const btnAll = document.getElementById("btnAll");
    const btnList = document.getElementById("btnList");

    const selTag = document.getElementById("selTag");
    const selectedName = document.getElementById("selectedName");
    const selectedHint = document.getElementById("selectedHint");

    const chip = document.getElementById("chip");
    const drawer = document.getElementById("drawer");
    const drawerList = document.getElementById("drawerList");
    const drawerClose = document.getElementById("drawerClose");

    /* ============================
       Mapa (sat√©lite + rua)
       ============================ */
    const lat = toNum(getParam("lat"));
    const lon = toNum(getParam("lon"));

    const map = L.map("map").setView(
      (!isNaN(lat) && !isNaN(lon)) ? [lat, lon] : [-6.05, -50.17],
      13
    );

    const rua = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
      maxZoom: 19
    });

    const sat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution: "Tiles ¬© Esri", maxZoom: 19 }
    );

    sat.addTo(map);

    L.control.layers(
      { "Sat√©lite (Esri)": sat, "Rua (OSM)": rua },
      null,
      { position: "topright" }
    ).addTo(map);

    // Ponto azul SEMPRE (mesmo fora de cobertura)
    if (!isNaN(lat) && !isNaN(lon)) {
      L.circleMarker([lat, lon], {
        radius: 7,
        color: "#0B5FFF",
        weight: 2,
        fillColor: "#0B5FFF",
        fillOpacity: 0.95
      }).addTo(map);
    }

    /* ============================
       Overlays (ovl JSON) ou fallback single overlay
       ============================ */
    let overlays = [];
    const ovlParam = getParam("ovl");

    if (ovlParam) {
      try {
        overlays = JSON.parse(decodeURIComponent(ovlParam));
        if (!Array.isArray(overlays)) overlays = [];
      } catch (e) {
        overlays = [];
      }
    }

    if (overlays.length === 0) {
      const imgUrl = getParam("img");
      const north = toNum(getParam("north"));
      const south = toNum(getParam("south"));
      const east  = toNum(getParam("east"));
      const west  = toNum(getParam("west"));
      const name  = getParam("name") ? decodeURIComponent(getParam("name")) : "Zona";

      if (imgUrl && !isNaN(north) && !isNaN(south) && !isNaN(east) && !isNaN(west)) {
        overlays = [{
          img: imgUrl,
          north, south, east, west,
          name,
          rank: 1
        }];
      }
    }

    /* ============================
       Estado / Opacidades
       ============================ */
    const group = L.featureGroup();
    const overlayLayers = []; // [{ layer, data, pillMarker }]
    let selectedIndex = -1;

    // Ajustes conforme voc√™ pediu:
    // - todos: 0.60
    // - selecionado: 0.50 (mais suave)
    // - outros: 0 (somem)
    const OPACITY_ALL = 0.60;
    const OPACITY_SELECTED = 0.50;
    const OPACITY_OTHERS = 0.0;

    /* ============================
       UI helpers
       ============================ */
    function openDrawer(open){
      drawer.style.display = open ? "block" : "none";
    }

    function renderChip(){
      chip.textContent = `${overlayLayers.length} zona${overlayLayers.length === 1 ? "" : "s"}`;
    }

    function setSelectedBox(data){
      if(!data){
        selTag.style.background = "#777";
        selTag.textContent = "P?";
        selectedName.textContent = "Nenhuma zona selecionada";
        selectedHint.textContent = "Clique numa mancha ou no pill (P# + nome) para filtrar.";
        return;
      }
      const rank = Number(data.rank || 0);
      selTag.style.background = cor(rank);
      selTag.textContent = "P" + rank;
      selectedName.textContent = data.name || "Zona";
      selectedHint.textContent = "Clique de novo no mesmo pill para voltar a mostrar todas.";
    }

    /* ============================
       Mostrar todas
       ============================ */
    function showAll(){
      selectedIndex = -1;

      overlayLayers.forEach(o => {
        o.layer.setOpacity(OPACITY_ALL);
        try { o.layer.bringToBack(); } catch(e){}
        if (o.pillMarker) o.pillMarker.setOpacity(1);
      });

      setSelectedBox(null);
    }

    /* ============================
       Selecionar (SOLO)
       ============================ */
    function selectOverlay(i, fit=false){
      if(i < 0 || i >= overlayLayers.length) return;
      selectedIndex = i;

      overlayLayers.forEach((o, idx) => {
        o.layer.setOpacity(idx === i ? OPACITY_SELECTED : OPACITY_OTHERS);
        if (o.pillMarker) o.pillMarker.setOpacity(idx === i ? 1 : 0);

        if(idx === i){
          try { o.layer.bringToFront(); } catch(e){}
        }
      });

      const data = overlayLayers[i].data;
      setSelectedBox(data);

      if(fit){
        const b = [[Number(data.south), Number(data.west)], [Number(data.north), Number(data.east)]];
        map.fitBounds(b, { padding:[25,25] });
      }
    }

    /* ============================
       Lista (drawer) sem üìå + thumbnail
       ============================ */
    function buildList(){
      drawerList.innerHTML = "";

      overlayLayers.forEach((o, idx) => {
        const d = o.data;

        const row = document.createElement("div");
        row.className = "row";

        row.innerHTML = `
          <span class="tag" style="background:${cor(d.rank)}">P${d.rank}</span>

          <div style="min-width:0; flex:1 1 auto;">
            <div class="name">${d.name || "Zona"}</div>
            <div class="meta">BBox: ${d.south}, ${d.west} ‚Üí ${d.north}, ${d.east}</div>
          </div>

          <img class="thumb" alt="preview" src="${d.img}">
        `;

        row.onclick = () => {
          selectOverlay(idx, true);
          openDrawer(false);
        };

        drawerList.appendChild(row);
      });
    }

    /* ============================
       Eventos UI
       ============================ */
    btnAll.onclick = () => showAll();
    btnList.onclick = () => openDrawer(true);

    chip.onclick = () => openDrawer(drawer.style.display !== "block");
    drawerClose.onclick = () => openDrawer(false);

    // Fechar painel (X) e tamb√©m pelo "üìå" no chip esquerdo
    function togglePanel(){
      panel.style.display = (panel.style.display === "none") ? "block" : "none";
    }
    panelClose.onclick = () => { panel.style.display = "none"; };
    btnTogglePanel.onclick = (e) => { e.stopPropagation(); togglePanel(); };

    /* ============================
       Render overlays + pills
       ============================ */
    if (overlays.length === 0) {
      renderChip();
      setSelectedBox(null);
      // drawer fica aberto, mas com 0 itens
      openDrawer(true);
    } else {
      overlays.forEach((o, idx) => {
        const north = Number(o.north), south = Number(o.south), east = Number(o.east), west = Number(o.west);
        const imgUrl = o.img;
        const nome = String(o.name || ("Zona " + (idx+1)));
        const rank = Number(o.rank || (idx+1));

        if (!imgUrl || [north,south,east,west].some(v => Number.isNaN(v))) return;

        const data = { img: imgUrl, north, south, east, west, name: nome, rank };
        const bounds = [[south, west], [north, east]];

        // overlay (opacidade geral por padr√£o)
        const layer = L.imageOverlay(imgUrl, bounds, { opacity: OPACITY_ALL, interactive: true })
          .addTo(map)
          .on("click", () => selectOverlay(idx));

        group.addLayer(layer);

        // pill clic√°vel no centro (toggle sele√ß√£o)
        const cLat = (south + north) / 2;
        const cLon = (west + east) / 2;

        const pillIcon = L.divIcon({
          className: "zone-pill",
          html: `<div class="pill">
                  <span class="tag" style="background:${cor(rank)}">P${rank}</span>
                  <span>${nome}</span>
                </div>`
        });

        const pillMarker = L.marker([cLat, cLon], {
          icon: pillIcon,
          interactive: true
        }).addTo(map);

        pillMarker.on("click", (e) => {
          L.DomEvent.stopPropagation(e);
          if (selectedIndex === idx) showAll();
          else selectOverlay(idx, true);
        });

        overlayLayers.push({ layer, data, pillMarker });
      });

      renderChip();
      buildList();
      setSelectedBox(null);

      // drawer come√ßa aberto (voc√™ pediu)
      openDrawer(true);

      // zoom inicial pra ver todas as manchas
      if (group.getLayers().length > 0) {
        map.fitBounds(group.getBounds(), { padding: [25,25] });
      }
    }
  </script>
</body>
</html>
