<script>
  function getParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }
  function toNum(v){
    if(v===null || v===undefined || v==="") return NaN;
    return Number(String(v).trim().replace(",", "."));
  }
  function cor(rank){
    if(rank===1) return "#0B8043";
    if(rank<=3) return "#6AA84F";
    if(rank<=5) return "#F1C232";
    if(rank<=8) return "#E69138";
    return "#B00020";
  }

  const msg = document.getElementById("msg");

  // Centro opcional (vem do Power Apps)
  const lat = toNum(getParam("lat"));
  const lon = toNum(getParam("lon"));

  const map = L.map("map").setView(
    (!isNaN(lat) && !isNaN(lon)) ? [lat, lon] : [-6.05, -50.17],
    13
  );

  // --- Base layers (Satélite + Rua)
  const rua = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors",
    maxZoom: 19
  });

  // ESRI World Imagery (satélite) — funciona bem no Leaflet
  const sat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { attribution: "Tiles © Esri", maxZoom: 19 }
  );

  // default: satélite (você pode trocar pra rua se quiser)
  sat.addTo(map);

  L.control.layers(
    { "Satélite (Esri)": sat, "Rua (OSM)": rua },
    null,
    { position: "topright" }
  ).addTo(map);

  // --- 1) Tenta modo novo: ovl (lista)
  let overlays = [];
  const ovlParam = getParam("ovl");
  if (ovlParam) {
    try {
      overlays = JSON.parse(decodeURIComponent(ovlParam));
      if (!Array.isArray(overlays)) overlays = [];
    } catch (e) {
      overlays = [];
    }
  }

  // --- 2) Se não tiver ovl, cai pro modo antigo (1 overlay)
  if (overlays.length === 0) {
    const imgUrl = getParam("img");
    const north = toNum(getParam("north"));
    const south = toNum(getParam("south"));
    const east  = toNum(getParam("east"));
    const west  = toNum(getParam("west"));
    const name  = getParam("name") || "Zona";

    if (imgUrl && !isNaN(north) && !isNaN(south) && !isNaN(east) && !isNaN(west)) {
      overlays = [{
        img: imgUrl,
        north, south, east, west,
        name: decodeURIComponent(name),
        rank: 1
      }];
    }
  }

  if (overlays.length === 0) {
    msg.textContent = "Sem parâmetros válidos. Use ovl=... (lista) ou img/north/south/east/west.";
  } else {
    // trava de segurança no HTML também
    overlays = overlays.slice(0, 20);

    const group = L.featureGroup();
    let carregadas = 0;

    overlays.forEach((o) => {
      const north = Number(o.north), south = Number(o.south), east = Number(o.east), west = Number(o.west);
      if ([north,south,east,west].some(v => Number.isNaN(v)) || !o.img) return;

      const bounds = [[south, west], [north, east]];
      const imgUrl = o.img; // aqui NÃO decodifica de novo (já veio certo do Power Apps)
      const rank = Number(o.rank || 0);
      const nome = String(o.name || "Zona");

      const overlay = L.imageOverlay(imgUrl, bounds, { opacity: 0.62, interactive: true })
        .addTo(map)
        .on("error", () => {
          msg.textContent = "Falhou ao carregar algum overlay (link/permissão/CORS).";
        })
        .on("load", () => {
          carregadas++;
          msg.textContent = `Overlays: ${carregadas}/${overlays.length} carregados.`;
        });

      group.addLayer(overlay);

      // Tooltip central com tag P#
      const cLat = (south + north) / 2;
      const cLon = (west + east) / 2;
      const html = `<span class="tag" style="background:${cor(rank)}">P${rank}</span>${nome}`;

      L.marker([cLat, cLon], { opacity: 0 })
        .addTo(map)
        .bindTooltip(html, { permanent: true, direction: "center", className: "zone-tooltip" });
    });

    // Ajusta zoom/área
    if (group.getLayers().length > 0) {
      map.fitBounds(group.getBounds(), { padding: [25, 25] });
      msg.textContent = `Carregando ${overlays.length} overlay(s)…`;
    } else {
      msg.textContent = "Lista ovl veio vazia/inválida.";
    }

    // Marca o ponto consultado (se veio)
    if (!isNaN(lat) && !isNaN(lon)) {
      L.circleMarker([lat, lon], { radius: 7, weight: 2, fillOpacity: 0.9 }).addTo(map);
    }
  }
</script>

