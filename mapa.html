<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa de Cobertura LTE</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100vh; }

    /* Painel (canto inferior esquerdo) recolhível */
    #panel {
      position:fixed; left:12px; bottom:12px; z-index:9999;
      width:320px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 12px 34px rgba(0,0,0,.18);
      font-family: Arial, sans-serif;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }
    #panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background:linear-gradient(180deg, #ffffff, #fbfbfb);
      border-bottom:1px solid rgba(0,0,0,.06);
      cursor:pointer;
      user-select:none;
    }
    #panelHeader .left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .tag{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:11px;
      color:#fff;
      flex:0 0 auto;
    }
    #pTitle{
      font-weight:800;
      font-size:12px;
      color:#111;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #panelHeader .chev{
      font-size:18px;
      color:#444;
      line-height:1;
      padding:4px 8px;
      border-radius:10px;
      background:#f2f2f2;
    }

    #panelBody{
      padding:10px 12px 12px;
      display:block;
    }
    #pSub{
      margin:0 0 10px 0;
      font-size:11px;
      color:#444;
      white-space:pre-line;
    }
    #pImg{
      width:100%;
      height:165px;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.08);
      background:#f3f3f3;
      display:block;
    }
    #panelActions{
      display:flex; gap:8px; margin-top:10px;
    }
    .btn{
      flex:1 1 auto;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.10);
      background:#fff;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{ background:#f7f7f7; }

    /* Chip (canto inferior direito) + Drawer list */
    #chip {
      position:fixed; right:12px; bottom:12px; z-index:9999;
      background:#111;
      color:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-family: Arial, sans-serif;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      box-shadow:0 12px 34px rgba(0,0,0,.22);
      user-select:none;
    }
    #drawer {
      position:fixed; right:12px; bottom:56px; z-index:9999;
      width:320px;
      max-height:60vh;
      background:#fff;
      border-radius:16px;
      box-shadow:0 12px 34px rgba(0,0,0,.18);
      border:1px solid rgba(0,0,0,.06);
      overflow:hidden;
      display:none;
      font-family: Arial, sans-serif;
    }
    #drawerHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background:linear-gradient(180deg, #ffffff, #fbfbfb);
      border-bottom:1px solid rgba(0,0,0,.06);
      font-weight:900;
      font-size:12px;
    }
    #drawerList{
      overflow:auto;
      max-height:calc(60vh - 44px);
    }
    .row{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 12px;
      border-bottom:1px solid rgba(0,0,0,.06);
      cursor:pointer;
    }
    .row:hover{ background:#f7f7f7; }
    .row .name{
      font-size:12px; font-weight:800; color:#111;
      line-height:1.2;
    }
    .row .meta{
      font-size:11px; color:#555; margin-top:2px;
    }

    /* Tooltip das tags no mapa */
    .zone-tooltip{
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      padding: 6px 8px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: #222;
    }
    .zone-tooltip .tag{
      padding: 2px 8px;
      font-size: 11px;
      margin-right: 6px;
    }

    /* Estado minimizado do painel */
    .min #panelBody{ display:none; }
    .min #panelHeader{ border-bottom:none; }

  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Painel preview (recolhível) -->
  <div id="panel" class="min">
    <div id="panelHeader" title="Clique para expandir/recolher">
      <div class="left">
        <span id="pTag" class="tag" style="background:#777;">P?</span>
        <div id="pTitle">Nenhuma zona selecionada</div>
      </div>
      <div class="chev" id="chev">⌃</div>
    </div>

    <div id="panelBody">
      <p id="pSub">Clique em uma mancha (overlay) ou escolha na lista.</p>
      <img id="pImg" alt="Prévia do overlay" />
      <div id="panelActions">
        <button class="btn" id="btnAll">Mostrar todas</button>
        <button class="btn" id="btnList">Lista de zonas</button>
      </div>
    </div>
  </div>

  <!-- Chip de quantidade + lista -->
  <div id="chip">0 zonas</div>

  <div id="drawer">
    <div id="drawerHeader">
      <div id="drawerTitle">Zonas de cobertura</div>
      <div style="cursor:pointer; padding:4px 8px; border-radius:10px; background:#f2f2f2;" id="drawerClose">✕</div>
    </div>
    <div id="drawerList"></div>
  </div>

  <script>
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }
    function toNum(v){
      if(v===null || v===undefined || v==="") return NaN;
      return Number(String(v).trim().replace(",", "."));
    }
    function cor(rank){
      rank = Number(rank || 0);
      if(rank === 1) return "#0B8043";
      if(rank <= 3) return "#6AA84F";
      if(rank <= 5) return "#F1C232";
      if(rank <= 8) return "#E69138";
      return "#B00020";
    }

    // UI refs
    const panel = document.getElementById("panel");
    const panelHeader = document.getElementById("panelHeader");
    const chev = document.getElementById("chev");
    const pTag = document.getElementById("pTag");
    const pTitle = document.getElementById("pTitle");
    const pSub = document.getElementById("pSub");
    const pImg = document.getElementById("pImg");

    const chip = document.getElementById("chip");
    const drawer = document.getElementById("drawer");
    const drawerList = document.getElementById("drawerList");
    const drawerClose = document.getElementById("drawerClose");

    const btnAll = document.getElementById("btnAll");
    const btnList = document.getElementById("btnList");

    // Centro opcional (vem do Power Apps)
    const lat = toNum(getParam("lat"));
    const lon = toNum(getParam("lon"));

    // Mapa
    const map = L.map("map").setView(
      (!isNaN(lat) && !isNaN(lon)) ? [lat, lon] : [-6.05, -50.17],
      13
    );

    // Base layers (satélite + rua)
    const rua = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
      maxZoom: 19
    });

    const sat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution: "Tiles © Esri", maxZoom: 19 }
    );

    sat.addTo(map);
    L.control.layers(
      { "Satélite (Esri)": sat, "Rua (OSM)": rua },
      null,
      { position: "topright" }
    ).addTo(map);

    // Ponto azul SEMPRE que vier lat/lon (mesmo fora)
    if (!isNaN(lat) && !isNaN(lon)) {
      L.circleMarker([lat, lon], {
        radius: 7,
        color: "#0B5FFF",
        weight: 2,
        fillColor: "#0B5FFF",
        fillOpacity: 0.95
      }).addTo(map);
    }

    // -------------------------
    // 1) Tenta modo novo: ovl
    // -------------------------
    let overlays = [];
    const ovlParam = getParam("ovl");
    if (ovlParam) {
      try {
        overlays = JSON.parse(decodeURIComponent(ovlParam));
        if (!Array.isArray(overlays)) overlays = [];
      } catch (e) {
        overlays = [];
      }
    }

    // -------------------------
    // 2) Fallback modo antigo
    // -------------------------
    if (overlays.length === 0) {
      const imgUrl = getParam("img");
      const north = toNum(getParam("north"));
      const south = toNum(getParam("south"));
      const east  = toNum(getParam("east"));
      const west  = toNum(getParam("west"));
      const name  = getParam("name") ? decodeURIComponent(getParam("name")) : "Zona";

      if (imgUrl && !isNaN(north) && !isNaN(south) && !isNaN(east) && !isNaN(west)) {
        overlays = [{
          img: imgUrl,
          north, south, east, west,
          name,
          rank: 1
        }];
      }
    }

    // Estado + camadas
    const group = L.featureGroup();
    const overlayLayers = []; // { layer, data, tooltipMarker }
    let selectedIndex = -1;

    function setPanelMin(min){
      if(min){
        panel.classList.add("min");
        chev.textContent = "⌃";
      } else {
        panel.classList.remove("min");
        chev.textContent = "⌄";
      }
    }

    function openDrawer(open){
      drawer.style.display = open ? "block" : "none";
    }

    function renderChip(){
      chip.textContent = `${overlayLayers.length} zona${overlayLayers.length === 1 ? "" : "s"}`;
    }

    function updatePreview(data){
      if(!data){
        pTag.style.background = "#777";
        pTag.textContent = "P?";
        pTitle.textContent = "Nenhuma zona selecionada";
        pSub.textContent = "Clique em uma mancha (overlay) ou escolha na lista.";
        pImg.removeAttribute("src");
        return;
      }
      const rank = Number(data.rank || 0);
      pTag.style.background = cor(rank);
      pTag.textContent = "P" + rank;
      pTitle.textContent = data.name || "Zona";
      pSub.textContent =
        `Prioridade: P${rank}\n` +
        `N ${data.north} | S ${data.south}\n` +
        `E ${data.east} | W ${data.west}`;
      pImg.src = data.img;
    }

    function showAll(){
      selectedIndex = -1;
      overlayLayers.forEach(o => {
        o.layer.setOpacity(0.62);
        try { o.layer.bringToBack(); } catch(e){}
      });
      updatePreview(null);
      setPanelMin(true);
    }

    function selectOverlay(i, fit=false){
      if(i < 0 || i >= overlayLayers.length) return;
      selectedIndex = i;

      overlayLayers.forEach((o, idx) => {
        o.layer.setOpacity(idx === i ? 0.85 : 0.25);
        if(idx === i){
          try { o.layer.bringToFront(); } catch(e){}
        }
      });

      const data = overlayLayers[i].data;
      updatePreview(data);
      setPanelMin(false);

      if(fit){
        const b = [[Number(data.south), Number(data.west)], [Number(data.north), Number(data.east)]];
        map.fitBounds(b, { padding:[25,25] });
      }
    }

    // Build drawer list
    function buildList(){
      drawerList.innerHTML = "";
      overlayLayers.forEach((o, idx) => {
        const d = o.data;
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <span class="tag" style="background:${cor(d.rank)}">P${d.rank}</span>
          <div style="min-width:0;">
            <div class="name">${d.name || "Zona"}</div>
            <div class="meta">BBox: ${d.south}, ${d.west} → ${d.north}, ${d.east}</div>
          </div>
        `;
        row.onclick = () => {
          selectOverlay(idx, true);
          openDrawer(false);
        };
        drawerList.appendChild(row);
      });
    }

    // Eventos UI
    panelHeader.onclick = () => setPanelMin(!panel.classList.contains("min") ? true : false);
    chip.onclick = () => { openDrawer(drawer.style.display !== "block"); };
    drawerClose.onclick = () => openDrawer(false);
    btnAll.onclick = (e) => { e.stopPropagation(); showAll(); };
    btnList.onclick = (e) => { e.stopPropagation(); openDrawer(true); };

    // Render overlays
    if (overlays.length === 0) {
      // Mesmo sem overlay, mantém ponto azul e deixa chip 0
      renderChip();
      updatePreview(null);
      setPanelMin(true);
    } else {
      overlays.forEach((o, idx) => {
        const north = Number(o.north), south = Number(o.south), east = Number(o.east), west = Number(o.west);
        const imgUrl = o.img;
        const nome = String(o.name || ("Zona " + (idx+1)));
        const rank = Number(o.rank || (idx+1));

        if (!imgUrl || [north,south,east,west].some(v => Number.isNaN(v))) return;

        const data = { img: imgUrl, north, south, east, west, name: nome, rank };

        const bounds = [[south, west], [north, east]];
        const layer = L.imageOverlay(imgUrl, bounds, { opacity: 0.62, interactive: true })
          .addTo(map)
          .on("click", () => selectOverlay(idx));

        group.addLayer(layer);

        // Tooltip/Tag no centro do bbox
        const cLat = (south + north) / 2;
        const cLon = (west + east) / 2;
        const html = `<span class="tag" style="background:${cor(rank)}">P${rank}</span>${nome}`;

        const tooltipMarker = L.marker([cLat, cLon], { opacity: 0 })
          .addTo(map)
          .bindTooltip(html, {
            permanent: true,
            direction: "center",
            className: "zone-tooltip"
          });

        overlayLayers.push({ layer, data, tooltipMarker });
      });

      renderChip();
      buildList();
      updatePreview(null);
      setPanelMin(true);

      // Ajusta o mapa para ver todas as manchas (se tiver)
      if (group.getLayers().length > 0) {
        map.fitBounds(group.getBounds(), { padding: [25, 25] });
      }
    }
  </script>
</body>
</html>
